name: Deploy Frontend

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Frontend via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "Navigating to frontend directory..."
            cd /home/ubuntu/frontend

            if [ ! -d ".git" ]; then
              echo "Cloning frontend repo..."
              rm -rf *
              git clone https://github.com/tejonidhi-wizzy/mern-frontend.git frontend
            else
              echo "Pulling latest changes..."
              git pull origin master
            fi

            echo "Installing dependencies..."
            npm install

            echo "Building React app..."
            npm run build

            echo "Starting frontend app with PM2..."
            pm2 delete frontend || true
            pm2 start serve --name frontend -- -s build -l 3000
            pm2 save

            echo "Deployment complete!"
         EOF
